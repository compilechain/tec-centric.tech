---
/** Matrix rain canvas. Activated by [data-effect="matrix"] (CSS). */
---
<canvas id="bg-matrix"></canvas>

<script is:inline>
  (function(){
    const c = document.getElementById('bg-matrix');
    if(!c) return;

    const ctx = c.getContext('2d', { alpha:false });

    let w,h,fontSize,cols,drops, running=false;

    function color(){
      const s = getComputedStyle(document.documentElement);
      const v = s.getPropertyValue('--brand').trim() || '#38BDF8';
      return v;
    }
    function resize(){
      w = c.width = innerWidth;
      h = c.height = innerHeight;
      fontSize = Math.max(14, Math.floor(w/80));
      cols = Math.floor(w / fontSize);
      drops = Array(cols).fill(0);
    }
    function step(){
      if(!running) return;
      ctx.fillStyle = 'rgba(7,11,16,0.15)'; ctx.fillRect(0,0,w,h);
      ctx.fillStyle = color();
      ctx.font = fontSize + 'px monospace';
      const glyphs = 'アカサタナハマヤラワ0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ';
      for(let i=0;i<drops.length;i++){
        const x = i * fontSize, y = drops[i] * fontSize;
        const ch = glyphs[(Math.random()*glyphs.length)|0];
        ctx.fillText(ch, x, y);
        if(y > h && Math.random() > 0.975) drops[i] = 0; else drops[i]++;
      }
      requestAnimationFrame(step);
    }

    function shouldRun(){
      const root = document.documentElement;
      if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) return false;
      return root.getAttribute('data-effect') === 'matrix';
    }

    function updateRun(){
      const now = shouldRun();
      if(now && !running){ running = true; step(); }
      if(!now){ running = false; }
    }

    addEventListener('resize', resize);
    const mo = new MutationObserver(updateRun);
    mo.observe(document.documentElement, { attributes:true, attributeFilter:['data-effect'] });

    resize(); updateRun();
  })();
</script>
