---
/** Matrix rain canvas. Shows when <html data-effect="matrix"> */
---
<canvas id="bg-matrix" style="position:fixed;inset:0;z-index:-2;display:none;pointer-events:none"></canvas>

<script is:inline>
(function(){
  const root = document.documentElement;
  const c = document.getElementById('bg-matrix');
  if(!c) return;
  const ctx = c.getContext('2d',{alpha:false});
  let w,h,fs,cols,drops,running=false;
  const glyphs='アカサタナハマヤラワ0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ';

  function col(){
    const s=getComputedStyle(root); return (s.getPropertyValue('--brand')||'#38BDF8').trim();
  }
  function resize(){
    w=c.width=innerWidth; h=c.height=innerHeight;
    fs=Math.max(14,Math.floor(w/80)); cols=Math.floor(w/fs); drops=Array(cols).fill(0);
  }
  function step(){
    if(!running) return;
    ctx.fillStyle='rgba(7,11,16,0.15)'; ctx.fillRect(0,0,w,h);
    ctx.fillStyle=col(); ctx.font=fs+'px monospace';
    for(let i=0;i<drops.length;i++){
      const x=i*fs, y=drops[i]*fs; const ch=glyphs[(Math.random()*glyphs.length)|0];
      ctx.fillText(ch,x,y); if(y>h&&Math.random()>0.975) drops[i]=0; else drops[i]++;
    }
    requestAnimationFrame(step);
  }
  function shouldRun(){
    if (matchMedia('(prefers-reduced-motion: reduce)').matches) return false;
    return root.getAttribute('data-effect')==='matrix';
  }
  function sync(){
    const on=shouldRun();
    c.style.display = on ? 'block' : 'none';
    if(on && !running){ running=true; step(); }
    if(!on){ running=false; }
  }
  addEventListener('resize',resize);
  new MutationObserver(sync).observe(root,{attributes:true,attributeFilter:['data-effect']});
  resize(); sync();
})();
</script>
